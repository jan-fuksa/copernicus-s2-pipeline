name: CI

on:
  push:
  pull_request:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read
  packages: read

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  unit:
    name: Unit tests
    runs-on: ubuntu-latest

    container:
      image: ghcr.io/jan-fuksa/copernicus-s2-pipeline/ci:latest
      credentials:
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    steps:
      - name: Checkout (with LFS)
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Mark workspace as safe for git
        run: git config --global --add safe.directory "$GITHUB_WORKSPACE"

      - name: Ensure LFS files are present
        run: |
          git lfs version
          git lfs checkout

      - name: Show python
        run: |
          which python || true
          python --version

      - name: Install project (editable)
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Run unit tests (not integration)
        run: |
          pytest -m "not integration" -q

  integration:
    name: Integration tests (PR to main only)
    runs-on: ubuntu-latest
    needs: unit

    if: |
      (github.event_name == 'pull_request' && github.event.pull_request.base.ref == 'main') ||
      (github.event_name == 'workflow_dispatch')

    container:
      image: ghcr.io/jan-fuksa/copernicus-s2-pipeline/ci:latest
      credentials:
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    steps:
      - name: Checkout (with LFS)
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Mark workspace as safe for git
        run: git config --global --add safe.directory "$GITHUB_WORKSPACE"

      - name: Ensure LFS files are present
        run: |
          git lfs version
          git lfs checkout

      - name: Install project (editable)
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Run integration tests
        run: |
          pytest -m "integration" -q
